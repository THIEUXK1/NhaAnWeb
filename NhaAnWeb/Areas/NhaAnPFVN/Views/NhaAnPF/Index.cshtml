@{
    int? chucVu = Context.Session.GetInt32("UserChucVu");
    bool showScanUI = chucVu.HasValue && (chucVu.Value == 1 || chucVu.Value == 3);
}
@{
    Layout = "~/Areas/NhaAnPFVN/Views/Shared/_Layout.cshtml";
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quét Mã </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body style="font-family: Arial, sans-serif; margin: 20px; padding: 0; background-color: #f0f0f0; position: relative;">
    <div id="totalMeals" style="position:absolute; top:0; right:10px; background-color:#fff; padding:10px; border:2px solid #000; border-radius:5px; font-size:30px; color:#e74c3c; font-weight:bold; z-index:1000; box-shadow:0 4px 6px rgba(0,0,0,0.3);">
        Tổng suất ăn: 0
    </div>

    <div id="totalGateMeals" style="position:absolute; top:0; left:10px; background-color:#fff; padding:10px; border:2px solid #000; border-radius:5px; font-size:30px; font-weight:bold; color:red; z-index:1000; box-shadow:0 4px 6px rgba(0,0,0,0.3);">
        Tổng suất ăn tại cổng: 0
    </div>

    <br />
    <div style="display:flex; justify-content:center; width:100%;">
        <h1 style="font-size:50px; font-weight:bold; color:#333; display:inline-block; background-color:#fff; padding:10px 20px; border-radius:5px; border:2px solid #000; box-shadow:0 4px 6px rgba(0,0,0,0.3); margin:0;">
            🍽️ Quét Mã Vạch Nhà Ăn
        </h1>
    </div>

    <h2 style="color: #666;">Nhập Mã </h2>
    <form id="barcodeForm" style="border-radius:10px; box-shadow:0 6px 12px rgba(0,0,0,0.15); padding:30px; font-size:24px; background-color:#f9f9f9; margin-bottom:20px; border:2px solid #000;">
        <div style="display: flex; gap: 20px; margin-bottom: 30px; width: 100%;">
            <div style="flex: 1; display: flex; flex-direction: column; justify-content: center;">
                <input type="text" id="barcode" name="barcode" autocomplete="off"
                       style='@((showScanUI) ? "width: 90%; padding: 20px; font-size: 24px; border-radius: 12px; border: 1px solid #ccc; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);" : "width: 1px; height: 1px; opacity: 0; position: absolute;")'
                       placeholder="Nhập mã vạch" />
                <p style="font-size: 24px; font-weight: bold; color: #2c3e50; margin-top: 10px;">
                    ⏰ Thời gian còn lại:
                    <span id="countdown" style="color: #e74c3c;">Đang tải...</span>
                </p>
            </div>
            <div style="flex: 1; display: flex; gap: 20px;">
                <div style="flex: 1; display: flex; gap: 20px;">
                    <select id="gate" name="gate"
                            style="flex: 1; font-size: 24px; border-radius: 12px; border: 2px solid #000; color: #444; background-color: #fff; outline: none; height: 64px; appearance: none; padding: 0 20px; background-image: url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 4 5&quot;%3E%3Cpath fill=&quot;%23666&quot; d=&quot;M2 0L0 2h4z&quot; /%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 15px center; background-size: 12px; cursor: pointer;">
                        <option value="0" disabled selected style="color: #999;">-- Chọn vị trí --</option>
                    </select>

                    @if (showScanUI)
                    {
                        <button type="button" onclick="handleBarcode()"
                                style="flex: 1; font-size: 24px; height: 64px; border-radius: 12px; background: linear-gradient(90deg, #007BFF, #00C6FF); color: white; border: 2px solid #000; cursor: pointer; transition: all 0.3s ease;"
                                onmouseover="this.style.transform='scale(1.05)';"
                                onmouseout="this.style.transform='scale(1)';">
                            Quét
                        </button>
                    }
                </div>
            </div>
        </div>
    </form>

    <div id="pingStatusBox" style="position: fixed; left: 0; top: 45%; z-index: 9999; background: #fffbe6; border: 4px solid #ffc107; border-radius: 10px 0 0 10px; min-width: 320px; max-height: 70vh; box-shadow: 0 4px 12px rgba(0,0,0,0.15); flex-direction: column; padding: 0; display: none;">
        <div style="display: flex; align-items: center; gap: 12px; padding: 18px 18px 12px 18px; border-bottom: 1px solid #ffc107; background: #fffde7; font-size: 22px; font-weight: bold; color: #ffc107; border-radius: 10px 0 0 0; flex-shrink: 0;">
            <span id="pingStatusDot" style="width:18px;height:18px;display:inline-block;border-radius:50%;background:#ccc;"></span>
            <span style="flex:1;" id="pingStatusTitle">Kết nối thiết bị chấm vân</span>
            <button id="hidePingBoxBtn"
                    style="background:#dc3545;color:#fff;border:none;border-radius:5px;padding:4px 12px;cursor:pointer;font-size:18px;">
                -
            </button>
        </div>
        <div id="pingStatusText" style="padding: 16px 18px 18px 18px; overflow-y: auto; flex: 1 1 auto; min-height: 40px; max-height: 50vh;">
            Đang kiểm tra kết nối...
        </div>
    </div>

    <button id="showPingBoxBtn" style="position: fixed; left: 0; top: 45%; z-index: 9999; background: #fffbe6; color: #333; border: 4px solid #ffc107; border-radius: 0 10px 10px 0; padding: 10px 18px; font-size: 28px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: none; cursor: pointer;">
        +
    </button>
    <audio id="tiengquetvan" src="~/Audio/amThanhOK/daNhanVanTay.mp3" preload="auto"></audio>

    <div id="statusMessage" style="
  position: fixed;
  top: 30%;
  right: 30px;
  width: 200px;
  height: 100px;
  font-size: 24px;
  font-weight: bold;
  text-align: center;
  display: none;
  align-items: center;
  justify-content: center;
  border-radius: 20px;
  padding: 20px;
  color: #000000; /* chữ đen */
  background: linear-gradient(135deg, #C8E6C9 0%, #E8F5E9 100%); /* xanh lá nhạt */
  border: 2px solid #006400; /* viền xanh đậm */
  box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
  transition: transform 0.3s, opacity 0.3s;
  z-index: 9999;
"></div>
    <div id="userSuccessMessageContainer" style="position: fixed; top: 45%; right: 30px; max-height: 60%; overflow: hidden; display: flex; flex-direction: column; gap: 8px; z-index: 9998;"></div>

    <h2 style="color: #666;">Thông Tin</h2>
    <form style="border-radius:5px; box-shadow:0 4px 6px rgba(0,0,0,0.3); padding:30px; font-size:24px; display:flex; gap:20px; justify-content:space-between; background-color:#fff; margin-bottom:20px; border:2px solid #000;">
        <div style="flex:1;">
            <label for="name" style="display:block; margin-bottom:15px;">Tên:</label>
            <input type="text" id="name" name="name" placeholder="Tên" style="width:95%; padding:20px; font-size:24px; border:2px solid #000; border-radius:5px;" />
        </div>
        <div style="flex:1;">
            <label for="dailyScans" style="display:block; margin-bottom:15px;">Số lượt quét trong ngày:</label>
            <input type="text" id="dailyScans" name="dailyScans" placeholder="Số lượt quét trong ngày" style="width:95%; padding:20px; font-size:24px; border:2px solid #000; border-radius:5px;" />
        </div>
    </form>

    <audio id="errorSound" src="~/Audio/ok/am-thanh-tra-loi-sai-wav-www.tiengdong.com.wav" preload="auto"></audio>
    <audio id="doneSound" src="~/Audio/amThanhOK/tieng_ting_mp3-www_tiengdong_com.mp3" preload="auto"></audio>

    <div id="loading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 9999; background-color: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; color: white; font-family: Arial, sans-serif; box-shadow: 0px 4px 10px rgba(0,0,0,0.5);">
        <div style="width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top: 5px solid white; border-radius: 50%; margin: 0 auto 10px; animation: spin 1s linear infinite;"></div>
        <p id="loading-text" style="font-size: 16px; font-weight: bold; margin-top: 10px;"></p>
    </div>
    <div id="message" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background-color: #fff; color: red; border-radius: 10px; max-width: 80%; text-align: center; z-index: 1000; display: none; border: 2px solid red; font-size: 36px; font-weight: bold;">
        <p id="message-text"></p>
        <button id="error-close-btn" onclick="closeMessage()" style="background-color: green; color: white; border: 2px solid green; padding: 10px 20px; margin-top: 10px; cursor: pointer; border-radius: 5px; font-size: 18px;">Đóng</button>
    </div>
    <script>
        (function () {
            const reloadTimes = [
                { hour: 10, minute: 55 },
                { hour: 16, minute: 55 },
                { hour: 23, minute: 55 }
            ];
            let hasReloadedFlags = reloadTimes.map(() => false);
            function checkReloadTime() {
                const now = new Date();
                const currentHour = now.getHours();
                const currentMinute = now.getMinutes();
                reloadTimes.forEach((time, index) => {
                    if (
                        currentHour === time.hour &&
                        currentMinute === time.minute &&
                        !hasReloadedFlags[index]
                    ) {
                        hasReloadedFlags[index] = true;
                        location.reload();
                    }
                });
                if (currentHour === 0 && currentMinute === 1) {
                    hasReloadedFlags = reloadTimes.map(() => false);
                }
            }
            setInterval(checkReloadTime, 60000);
        })();
        async function fetchSessionTime() {
            try {
                const response = await fetch('/PF/GetSessionRemainingTime');
                const data = await response.json();
                if (!data.success) {
                    document.getElementById("countdown").innerText = data.message || "Hết phiên";
                    return;
                }
                let totalSeconds = data.hours * 3600 + data.minutes * 60 + data.seconds;
                function formatTime(h, m, s) {
                    return `${h} giờ ${m} phút ${s} giây`;
                }
                function updateCountdown() {
                    if (totalSeconds <= 0) {
                        document.getElementById("countdown").innerText = "Hết phiên đăng nhập";
                        clearInterval(timer);
                        return;
                    }
                    const hours = Math.floor(totalSeconds / 3600);
                    const minutes = Math.floor((totalSeconds % 3600) / 60);
                    const seconds = totalSeconds % 60;
                    document.getElementById("countdown").innerText = formatTime(hours, minutes, seconds);
                    totalSeconds--;
                }
                updateCountdown();
                const timer = setInterval(updateCountdown, 1000);
            } catch (error) {
                console.error("Lỗi khi lấy thời gian phiên:", error);
                document.getElementById("countdown").innerText = "Không thể lấy thời gian phiên";
            }
        }
      
        function fetchTotalMeals() {
            $.ajax({
                url: '/PF/TotalMeals',
                type: 'GET',
                success: function (response) {
                    if (response.error) {
                        console.error('Error:', response.error);
                    } else {
                        updateTotalMeals(response);
                    }
                },
                error: function (xhr, status, error) {
                    console.error('Failed to fetch total meals:', error);
                }
            });
        }
        function updateTotalMeals(totalMeals) {
            document.getElementById("totalMeals").innerText = "Tổng suất ăn: " + totalMeals;
        }
  
        function getCurrentTimestamp() {
            var now = new Date();
            var yyyy = now.getFullYear();
            var MM = String(now.getMonth() + 1).padStart(2, "0");
            var dd = String(now.getDate()).padStart(2, "0");
            var HH = String(now.getHours()).padStart(2, "0");
            var mm = String(now.getMinutes()).padStart(2, "0");
            var ss = String(now.getSeconds()).padStart(2, "0");
            return `${yyyy}${MM}${dd}_${HH}${mm}${ss}`;
        }
        function updateGateMealCount(gateId) {
            var xhr = new XMLHttpRequest();
            xhr.open("GET", "/PF/GetMealCountByGate?idgate=" + encodeURIComponent(gateId), true);
            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        if (response.count !== undefined) {
                            document.getElementById("totalGateMeals").textContent = "Tổng suất ăn tại cổng: " + response.count;
                        } else {
                            console.error("Phản hồi không hợp lệ:", response);
                        }
                    } else {
                        console.error("Request failed: ", xhr.status);
                    }
                }
            };
            xhr.send();
        }
        function closeMessage() {
            document.getElementById("message").style.display = "none";
            document.getElementById("overlay").style.display = "none";
            document.getElementById("barcode").value = "";
            document.getElementById("barcode").focus();
        }
        function showMessage(message) {
            document.getElementById('message-text').innerText = message;
            document.getElementById('message').style.display = 'block';
            document.getElementById("barcode").value = "";
            document.getElementById("barcode").focus();
        }

        function toggleAddEmployeeForm() {
            var addEmployeeForm = document.getElementById("addEmployeeForm");
            if (addEmployeeForm.style.display === "block") {
                addEmployeeForm.style.display = "none";
            } else {
                addEmployeeForm.style.display = "block";
            }
        }
      
        document.addEventListener("DOMContentLoaded", () => {
            fetch("/PF/Gate")
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Không thể tải danh sách cổng");
                    }
                    return response.json();
                })
                .then(data => {
                    const gateSelect = document.getElementById("gate");
                    if (!data || data.length === 0) {
                        const option = document.createElement("option");
                        option.value = "";
                        option.textContent = "-- Không có cổng khả dụng --";
                        gateSelect.appendChild(option);
                        return;
                    }
                    data.forEach(item => {
                        const option = document.createElement("option");
                        option.value = item.id;
                        option.textContent = item.gName;
                        gateSelect.appendChild(option);
                    });
                    const savedGate = localStorage.getItem("selectedGate");
                    if (savedGate) {
                        gateSelect.value = savedGate;
                        triggerGateChange(gateSelect);
                    }
                })
                .catch(error => {
                    console.error("Lỗi khi tải danh sách cổng:", error);
                    const gateSelect = document.getElementById("gate");
                    const option = document.createElement("option");
                    option.value = "";
                    option.textContent = "-- Lỗi khi tải danh sách cổng --";
                    gateSelect.appendChild(option);
                });
            document.getElementById("gate").addEventListener("change", (event) => {
                const selectedGateId = event.target.value;
                localStorage.setItem("selectedGate", selectedGateId);
                const pingBox = document.getElementById("pingStatusBox");
                if (selectedGateId === "1") {
                    pingBox.style.display = "flex";
                } else {
                    pingBox.style.display = "none";
                }
                if (selectedGateId) {
                    fetch(`/PF/GetMealCountByGate?idgate=${selectedGateId}`)
                        .then(response => response.json())
                        .then(data => {
                            const totalGateMealsDiv = document.getElementById("totalGateMeals");
                            if (data.count !== undefined) {
                                totalGateMealsDiv.textContent = `Tổng suất ăn tại cổng: ${data.count}`;
                            } else {
                                totalGateMealsDiv.textContent = "Không thể lấy dữ liệu.";
                            }
                        })
                        .catch(error => {
                            console.error("Lỗi khi gọi API:", error);
                            document.getElementById("totalGateMeals").textContent = "Lỗi kết nối.";
                        });
                }
                const body = document.body;
                if (selectedGateId === "1") {
                    body.style.background = "linear-gradient(to bottom right, #ffcccc, #ffb3b3)";
                } else if (selectedGateId === "2") {
                    body.style.background = "linear-gradient(to bottom right, #ffecb3, #ffdb99)";
                } else if (selectedGateId === "3") {
                    body.style.background = "linear-gradient(to bottom right, #ffffb3, #f2f2b3)";
                } else if (selectedGateId === "4") {
                    body.style.background = "linear-gradient(to bottom right, #b3ffb3, #99ff99)";
                } else {
                    body.style.background = "";
                }
            });
            function triggerGateChange(gateSelect) {
                const event = new Event("change");
                gateSelect.dispatchEvent(event);
            }
        });
      
    </script>
</body>
</html>
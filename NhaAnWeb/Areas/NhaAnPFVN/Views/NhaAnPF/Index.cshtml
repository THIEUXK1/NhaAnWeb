@{
    int? chucVu = Context.Session.GetInt32("UserChucVu");
    bool showScanUI = chucVu.HasValue && (chucVu.Value == 1 || chucVu.Value == 3);
    Layout = "~/Areas/NhaAnPFVN/Views/Shared/_Layout.cshtml";
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>🍽️ Quét Mã Nhà Ăn</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; margin:20px; background:#f0f0f0; overflow-x:hidden; }
        #totalMeals, #totalGateMeals {
            position:absolute; top:10px; padding:14px 20px; border:2px solid #000; border-radius:12px;
            font-size:24px; font-weight:700; box-shadow:0 8px 20px rgba(0,0,0,0.18); background:#fff; z-index:1000;
        }
        #totalMeals { right:12px; color:#e74c3c; }
        #totalGateMeals { left:12px; color:#c0392b; }

        h1 { font-size:48px; font-weight:800; color:#222; background:#fff; padding:14px 26px; border-radius:14px; border:2px solid #000; box-shadow:0 8px 20px rgba(0,0,0,0.18); margin:0; text-align:center; }

        .fixed-left { position:fixed; top:110px; left:16px; z-index:1000; background:#fff; border:2px solid #000; border-radius:12px; padding:12px 16px; box-shadow:0 8px 20px rgba(0,0,0,0.18); font-size:16px; }

        #scanLegend { display:flex; gap:12px; justify-content:center; margin:20px 0 12px 0; flex-wrap:wrap; }
        #scanLegend div { display:flex; align-items:center; gap:4px; }

        #attLogsForm { position:relative; top:70px; margin:0 auto; max-height:1000px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.15); padding:22px; font-size:16px; background:#fff; margin-bottom:20px; border:2px solid #000; }
        #logStats { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; gap:12px; flex-wrap:wrap; }
        #attLogsContainer { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:16px; max-height:620px; overflow-y:auto; padding:6px; }

        .toggle-button { margin-bottom:10px; cursor:pointer; background: linear-gradient(90deg, #007BFF, #00C6FF); color:white; padding:10px 20px; border:2px solid #000; border-radius:8px; font-size:16px; box-shadow:0 4px 6px rgba(0,0,0,0.3); transition: transform 0.2s; }

        .button-container { display:none; margin-top:10px; padding:15px; border:2px solid #000; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.15); background: linear-gradient(135deg, #fef9f9, #f0f0f0); }

        #dateForm { display:none; border-radius:8px; border:2px solid #000; box-shadow:0 4px 6px rgba(0,0,0,0.3); padding:10px; background:#f8f9fa; margin-top:10px; }

        .card { border:2px solid #000; border-radius:12px; padding:14px; box-shadow:0 8px 18px rgba(0,0,0,0.12); font-size:15px; transition:transform 0.18s ease, box-shadow 0.18s ease; display:flex; flex-direction:column; gap:6px; }
        .card:hover { transform: scale(1.04); box-shadow:0 12px 30px rgba(0,0,0,0.22); }
    </style>
</head>
<body>

    <!-- Tổng suất ăn -->
    <div id="totalMeals">Tổng suất ăn: 0</div>
    <div id="totalGateMeals">Tổng suất ăn tại cổng: 0</div>

    <!-- Tiêu đề -->
    <h1>🍽️ Quét Mã Nhà Ăn</h1>

    <!-- Chọn cổng -->
    <div class="fixed-left">
        <label for="gate" style="font-weight:700; color:#222; display:block; margin-bottom:8px;">Chọn Cổng</label>
        <select id="gate" style="font-size:16px; border-radius:10px; border:2px solid #000; color:#333; background:#fff; outline:none; height:44px; padding:0 12px; cursor:pointer; width:220px; -webkit-appearance:none; appearance:none; background-image:url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 4 5&quot;%3E%3Cpath fill=&quot;%23666&quot; d=&quot;M2 0L0 2h4z&quot; /%3E%3C/svg%3E'); background-repeat:no-repeat; background-position:right 12px center; background-size:12px;">
            <option value="0" disabled selected style="color:#999;">-- Chọn vị trí --</option>
        </select>
        <div id="currentMeal" style="margin-top:10px; font-weight:700; color:#222;">Ca hiện tại: --</div>
    </div>

    <!-- Chú thích số lượt quét -->
    <div id="scanLegend">
        <div><div style="width:20px; height:20px; background:#b3ffb3; border:1px solid #000;"></div><span>1 lần</span></div>
        <div><div style="width:20px; height:20px; background:#ffff99; border:1px solid #000;"></div><span>2 lần</span></div>
        <div><div style="width:20px; height:20px; background:#ffb366; border:1px solid #000;"></div><span>3 lần</span></div>
        <div><div style="width:20px; height:20px; background:#ff6666; border:1px solid #000;"></div><span>4 lần trở lên</span></div>
    </div>

    <!-- Form danh sách log -->
    <form id="attLogsForm">
        <div id="logStats">
            <div id="recordCount" style="color:#e74c3c; font-weight:800; font-size:18px;">Số lượt quét: 0</div>
            <div id="uniqueCount" style="color:#27ae60; font-weight:800; font-size:18px;">Số người thực tế: 0</div>
            <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
                <button type="button" id="refreshBtn" style="cursor:pointer; border:2px solid #000; background:#fff; padding:8px 12px; border-radius:10px; font-weight:700;">Refresh</button>
                <button type="button" id="exportBtn" style="cursor:pointer; border:2px solid #000; background:#fff; padding:8px 12px; border-radius:10px; font-weight:700;">Export Excel</button>
            </div>
        </div>
        <div id="attLogsContainer"><p style="text-align:center; width:100%; font-weight:700; color:#666;">Chưa có dữ liệu</p></div>
    </form>

    <!-- Toggle button + container -->
    <div style="text-align:center; margin-top:120px;">
        <button class="toggle-button" onclick="toggleButtons()">▼ Hiển thị tùy chọn</button>
        <div class="button-container" id="buttonContainer">
            <form method="post" action="/Best/XuatEXThang">
                <input type="month" name="selectedMonth" required style="border:2px solid #000; border-radius:5px; padding:8px; margin-bottom:5px;" />
                <button type="submit" style="border-radius:6px; border:2px solid #000; background:#28a745; color:white; padding:8px 16px; box-shadow:0 3px 5px rgba(0,0,0,0.3); margin-bottom:5px;">Báo cáo tổng quát tháng</button>
            </form>
            <button onclick="redirectToPage1()" style="border-radius:6px; border:2px solid #000; background:#ffc107; color:#000; padding:8px 16px; box-shadow:0 3px 5px rgba(0,0,0,0.3); margin-bottom:5px;">Black list</button>
            <button onclick="window.location.href='/NhaAnPFVN/NhaAnPF/KhachAn'" style="border-radius:6px; border:2px solid #000; background:#17a2b8; color:white; padding:8px 16px; box-shadow:0 3px 5px rgba(0,0,0,0.3); margin-bottom:5px;">Thêm Khách ăn</button>
            <button onclick="showDateForm()" style="border-radius:6px; border:2px solid #000; background:#6f42c1; color:white; padding:8px 16px; box-shadow:0 3px 5px rgba(0,0,0,0.3); margin-bottom:5px;">Báo cáo ngày hôm nay</button>
            <button onclick="redirectToCheckAnh()" style="border-radius:6px; border:2px solid #000; background:#fd7e14; color:white; padding:8px 16px; box-shadow:0 3px 5px rgba(0,0,0,0.3); margin-bottom:5px;">Check suất ăn chi tiết</button>
            <button onclick="redirectToCheckQT()" style="border-radius:6px; border:2px solid #000; background:#dc3545; color:white; padding:8px 16px; box-shadow:0 3px 5px rgba(0,0,0,0.3); margin-bottom:5px;">Check quên thẻ</button>
        </div>

        <!-- Form chọn ngày -->
        <div id="dateForm">
            <label for="startDate">Ngày bắt đầu:</label>
            <input type="date" id="startDate" style="border:2px solid #000; border-radius:5px; padding:5px; margin-right:5px;" />
            <label for="endDate">Ngày kết thúc:</label>
            <input type="date" id="endDate" style="border:2px solid #000; border-radius:5px; padding:5px; margin-right:5px;" />
            <button onclick="submitDates()" style="border-radius:6px; border:2px solid #000; background:#20c997; color:white; padding:5px 12px; box-shadow:0 3px 5px rgba(0,0,0,0.3); margin-top:5px;">Xác nhận</button>
        </div>
    </div>

    <!-- Audio -->
    <audio id="newEntrySound" src="/Audio/amThanhOK/NhanDien.mp3" preload="auto"></audio>

<script>
function toggleButtons(){
    const container=document.getElementById("buttonContainer");
    const btn=document.querySelector(".toggle-button");
    if(container.style.display==="none"||container.style.display===""){container.style.display="block"; btn.innerHTML="▲ Ẩn tùy chọn";}
    else{container.style.display="none"; btn.innerHTML="▼ Hiển thị tùy chọn";}
}

function showDateForm(){
    const f=document.getElementById("dateForm");
    f.style.display=(f.style.display==="none"||f.style.display==="")?"block":"none";
}

function submitDates(){
    const start=document.getElementById("startDate").value;
    const end=document.getElementById("endDate").value;
    if(!start||!end){alert("Vui lòng chọn cả ngày bắt đầu và kết thúc!"); return;}
    if(start>end){alert("Ngày bắt đầu phải trước hoặc bằng ngày kết thúc!"); return;}
    fetch(`/PF/ExportAttLogsToExcel?start=${start}&end=${end}`).then(r=>{if(!r.ok)throw new Error("Lỗi!");return r.blob();}).then(b=>{
        const url=window.URL.createObjectURL(b);
        const a=document.createElement("a"); a.href=url; a.download=`AttLogs_${start}_to_${end}.xlsx`; document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url);
    }).catch(e=>alert("Xuất dữ liệu thất bại!"));
}

document.addEventListener("DOMContentLoaded",()=>{
    const gateSelect=document.getElementById("gate");
    const container=document.getElementById("attLogsContainer");
    const totalGateMeals=document.getElementById("totalGateMeals");
    const totalMeals=document.getElementById("totalMeals");
    const recordCountDiv=document.getElementById("recordCount");
    const uniqueCountDiv=document.getElementById("uniqueCount");
    const currentMealDiv=document.getElementById("currentMeal");
    const refreshBtn=document.getElementById("refreshBtn");
    const exportBtn=document.getElementById("exportBtn");
    const newEntrySound=document.getElementById("newEntrySound");

    let lastRecordCount=0;
    let lastRawData=[];

    fetch("/PF/Gate").then(r=>r.json()).then(data=>{
        if(!Array.isArray(data)) return;
        data.forEach(g=>{
            const opt=document.createElement("option");
            opt.value=g.id; opt.textContent=g.gName||g.GName||g.gName;
            gateSelect.appendChild(opt);
        });
        const savedGate=localStorage.getItem("selectedGate");
        if(savedGate){gateSelect.value=savedGate; triggerGateChange();}
    }).catch(e=>console.error(e));

    gateSelect.addEventListener("change", triggerGateChange);
    refreshBtn.addEventListener("click",()=>{if(gateSelect.value) loadAttLogs(gateSelect.value);});
    exportBtn.addEventListener("click",()=>{if(!lastRawData.length){alert("Không có dữ liệu để xuất.");return;}
        const ws_data=[["Mã NV","Họ tên","Thời gian","Hướng","Máy quét"]];
        lastRawData.forEach(r=>ws_data.push([r.employeeId,r.personName,r.authDateTime,r.direction,r.deviceName]));
        const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(ws_data); XLSX.utils.book_append_sheet(wb,ws,"Logs"); XLSX.writeFile(wb,"AttLogs.xlsx");
    });

    function triggerGateChange(){
        const gateId=gateSelect.value; if(!gateId) return;
        localStorage.setItem("selectedGate",gateId);
        updateGateMeals(gateId); loadAttLogs(gateId); updateBackground(gateId); updateCurrentMealLabel();
    }

function updateTotalMeals() {
    fetch("/PF/TotalMeals")
        .then(res => res.json())
        .then(data => {
            // Kiểm tra đúng kiểu số
            const val = (data && typeof data.totalMeals === "number") ? data.totalMeals : 0;
            document.getElementById("totalMeals").textContent = `Tổng suất ăn: ${val}`;
        })
        .catch(err => {
            console.error(err);
            document.getElementById("totalMeals").textContent = `Tổng suất ăn: 0`;
        });
}

  function updateGateMeals(gateId){
    fetch(`/PF/GetMealCountByGate?idgate=${gateId}`)
        .then(r => r.json())
        .then(d => {
            const cnt = (d && (d.count || d.count === 0) ? d.count : 0);
            totalGateMeals.textContent = `Tổng suất ăn tại cổng: ${cnt}`;
        })
        .catch(() => { totalGateMeals.textContent = `Tổng suất ăn tại cổng: 0`; });
}


    function determineMealNow(){
        const now=new Date(); const t=now.getHours()*60+now.getMinutes();
        const m=(h,m)=>h*60+m;
        if(t>=m(5,0)&&t<m(8,0)) return {name:"Sáng",start:"05:00",end:"08:00"};
        if(t>=m(10,0)&&t<m(13,0)) return {name:"Trưa",start:"11:00",end:"13:00"};
        if(t>=m(16,30)&&t<m(19,0)) return {name:"Tối",start:"16:30",end:"19:00"};
        if(t>=m(23,30)||t<m(1,0)) return {name:"Đêm",start:"23:30",end:"01:00"};
        return null;
    }

    function updateCurrentMealLabel(){
        const meal=determineMealNow();
        currentMealDiv.textContent=meal?`Ca hiện tại: ${meal.name} (${meal.start} - ${meal.end})`:`Ca hiện tại: Không phải giờ ăn`;
    }

    function loadAttLogs(gateId){
        fetch(`/PF/GetAttLogsByGate?idgate=${gateId}`).then(r=>r.json()).then(data=>{
            let logs=Array.isArray(data)?data:(Array.isArray(data.data)?data.data:[]);
            lastRawData=logs.slice();
            container.innerHTML=""; if(!logs.length){container.innerHTML='<p style="text-align:center; font-weight:700; color:#666;">Không có dữ liệu</p>'; recordCountDiv.textContent="Số lượt quét: 0"; uniqueCountDiv.textContent="Số người thực tế: 0"; lastRecordCount=0; return;}
            const recordCount=logs.length; recordCountDiv.textContent=`Số lượt quét: ${recordCount}`;
            const uniqueCount=[...new Set(logs.map(l=>l.employeeId))].length; uniqueCountDiv.textContent=`Số người thực tế: ${uniqueCount}`;
            const counts={}; logs.forEach(l=>{const id=l.employeeId||l.EmployeeId||"--"; counts[id]=(counts[id]||0)+1;});
            logs.sort((a,b)=>((b.authDateTime||b.AuthDateTime||"").localeCompare(a.authDateTime||a.AuthDateTime||"")));
            logs.forEach(l=>{
                const id=l.employeeId||l.EmployeeId||"--"; const name=l.personName||l.PersonName||"--"; const time=l.authDateTime||l.AuthDateTime||""; const dir=l.direction||l.Direction||"--"; const dev=l.deviceName||l.DeviceName||"--";
                const times=counts[id]||1; let bg="#b3ffb3"; if(times===2)bg="#ffff99"; else if(times===3)bg="#ffb366"; else if(times>=4)bg="#ff6666";
                const card=document.createElement("div"); card.className="card"; card.style.background=bg;
                card.innerHTML=`<div style="display:flex; justify-content:space-between; align-items:center;"><div style="font-weight:800;">Mã NV: <span style="font-weight:700; color:#000;">${id}</span></div><div style="font-size:13px; font-weight:800;">Lần: <span style="font-weight:900;">${times}</span></div></div><div style="font-size:14px; color:#111;"><strong>Họ tên:</strong> ${name}</div><div style="font-size:13px; color:#111;"><strong>Thời gian:</strong> ${time}</div><div style="font-size:13px; color:#111;"><strong>Hướng quét:</strong> ${dir}</div><div style="font-size:13px; color:#111;"><strong>Máy quét:</strong> ${dev}</div>`;
                container.appendChild(card);
            });
            if(recordCount>lastRecordCount){newEntrySound.pause(); newEntrySound.currentTime=0; newEntrySound.play().catch(e=>console.warn(e));}
            lastRecordCount=recordCount;
        }).catch(e=>{console.error(e); container.innerHTML='<p style="text-align:center; font-weight:700; color:#666;">Lỗi khi tải dữ liệu</p>';});
    }

    function updateBackground(gateId){
        const b=document.body;
        if(gateId==="1") b.style.background="linear-gradient(135deg, #ffcccc, #ffb3b3)";
        else if(gateId==="2") b.style.background="linear-gradient(135deg, #ffecb3, #ffd699)";
        else if(gateId==="3") b.style.background="linear-gradient(135deg, #fff5b3, #f2f2b3)";
        else if(gateId==="4") b.style.background="linear-gradient(135deg, #c8ffd1, #99ffb3)";
        else b.style.background="#f0f0f0";
    }

    fetch("/PF/TotalMeals").then(r=>r.json()).then(d=>{const val=typeof d==="number"?d:(d&&d.total?d.total:(d||0)); totalMeals.textContent=`Tổng suất ăn: ${val||0}`;}).catch(()=>{totalMeals.textContent="Tổng suất ăn: 0";});

   // Cập nhật dữ liệu mỗi 2 giây
setInterval(() => {
    const gateId = gateSelect.value;

    if (gateId) {
        updateGateMeals(gateId);   // Cập nhật tổng suất ăn theo cổng
        loadAttLogs(gateId);       // Tải danh sách log
        updateTotalMeals();        // Cập nhật tổng suất ăn toàn bộ
    }

    updateCurrentMealLabel();      // Cập nhật nhãn ca hiện tại luôn
}, 2000);

// Cập nhật nhãn ca ngay khi load trang
updateCurrentMealLabel();

});
</script>

</body>
</html>

@{
    int? chucVu = Context.Session.GetInt32("UserChucVu");
    bool showScanUI = chucVu.HasValue && (chucVu.Value == 1 || chucVu.Value == 3);
}
@{
    Layout = "~/Areas/NhaAnPFVN/Views/Shared/_Layout.cshtml";
}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quét Mã</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body style="font-family: Arial, sans-serif; margin: 20px; padding: 0; background-color: #f0f0f0; position: relative;">

    <!-- Tổng suất ăn toàn bộ -->
    <div id="totalMeals" style="position:absolute; top:0; right:10px; background-color:#fff; padding:10px; border:2px solid #000; border-radius:5px; font-size:30px; color:#e74c3c; font-weight:bold; z-index:1000; box-shadow:0 4px 6px rgba(0,0,0,0.3);">
        Tổng suất ăn: 0
    </div>

    <!-- Tổng suất ăn tại cổng -->
    <div id="totalGateMeals" style="position:absolute; top:0; left:10px; background-color:#fff; padding:10px; border:2px solid #000; border-radius:5px; font-size:30px; font-weight:bold; color:red; z-index:1000; box-shadow:0 4px 6px rgba(0,0,0,0.3);">
        Tổng suất ăn tại cổng: 0
    </div>

    <!-- Tiêu đề -->
    <div style="display:flex; justify-content:center; width:100%;">
        <h1 style="font-size:50px; font-weight:bold; color:#333; display:inline-block; background-color:#fff; padding:10px 20px; border-radius:5px; border:2px solid #000; box-shadow:0 4px 6px rgba(0,0,0,0.3); margin:0;">
            🍽️ Quét Mã Nhà Ăn
        </h1>
    </div>

    <!-- Chọn cổng -->
    <div style="position:fixed;top:85px;left:15px;z-index:1000;background:#fff;border:2px solid #000;border-radius:10px;padding:10px 15px;box-shadow:0 4px 8px rgba(0,0,0,0.2);font-size:18px;">
        <label for="gate" style="font-weight:bold;color:#333;display:block;margin-bottom:5px;">Chọn Cổng</label>
        <select id="gate" name="gate" style="font-size:18px;border-radius:8px;border:2px solid #000;color:#444;background:#fff;outline:none;height:40px;padding:0 10px;cursor:pointer;width:180px;appearance:none;background-image:url('data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=&quot;http://www.w3.org/2000/svg&quot; viewBox=&quot;0 0 4 5&quot;%3E%3Cpath fill=&quot;%23666&quot; d=&quot;M2 0L0 2h4z&quot; /%3E%3C/svg%3E');background-repeat:no-repeat;background-position:right 10px center;background-size:10px;">
            <option value="0" disabled selected style="color:#999;">-- Chọn vị trí --</option>
        </select>
    </div>

    <!-- Audio -->
    <audio id="tiengquetvan" src="~/Audio/amThanhOK/daNhanVanTay.mp3" preload="auto"></audio>
    <audio id="errorSound" src="~/Audio/ok/am-thanh-tra-loi-sai-wav-www.tiengdong.com.wav" preload="auto"></audio>
    <audio id="doneSound" src="~/Audio/amThanhOK/tieng_ting_mp3-www_tiengdong_com.mp3" preload="auto"></audio>

    <!-- Bảng AttLogs -->
   <form id="attLogsForm" style="position:relative; top:150px; border-radius:5px; box-shadow:0 4px 6px rgba(0,0,0,0.3); padding:20px; font-size:18px; display:block; background-color:#fff; margin-bottom:20px; border:2px solid #000;">
    <div style="max-height:400px; overflow-y:auto;">
        <table id="attLogsTable" style="width:100%; border-collapse: collapse;">
            <thead>
                <tr style="background:#f0f0f0;">
                    <th style="border:1px solid #000; padding:5px;">Mã NV</th>
                    <th style="border:1px solid #000; padding:5px;">Họ tên</th>
                    <th style="border:1px solid #000; padding:5px;">Thời gian</th>
                    <th style="border:1px solid #000; padding:5px;">Hướng quét</th>
                    <th style="border:1px solid #000; padding:5px;">Máy Quét</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</form>


    <!-- Loading -->
    <div id="loading" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; z-index: 9999; background-color: rgba(0,0,0,0.7); padding: 20px; border-radius: 10px; color: white; font-family: Arial, sans-serif; box-shadow: 0px 4px 10px rgba(0,0,0,0.5);">
        <div style="width: 50px; height: 50px; border: 5px solid rgba(255,255,255,0.3); border-top: 5px solid white; border-radius: 50%; margin: 0 auto 10px; animation: spin 1s linear infinite;"></div>
        <p id="loading-text" style="font-size: 16px; font-weight: bold; margin-top: 10px;"></p>
    </div>

    <!-- Message -->
    <div id="message" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 20px; background-color: #fff; color: red; border-radius: 10px; max-width: 80%; text-align: center; z-index: 1000; display: none; border: 2px solid red; font-size: 36px; font-weight: bold;">
        <p id="message-text"></p>
        <button id="error-close-btn" onclick="closeMessage()" style="background-color: green; color: white; border: 2px solid green; padding: 10px 20px; margin-top: 10px; cursor: pointer; border-radius: 5px; font-size: 18px;">Đóng</button>
    </div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const gateSelect = document.getElementById("gate");

    // Tải danh sách cổng
    fetch("/PF/Gate")
        .then(res => res.json())
        .then(data => {
            data.forEach(gate => {
                const opt = document.createElement("option");
                opt.value = gate.id;
                opt.textContent = gate.gName;
                gateSelect.appendChild(opt);
            });

            const savedGate = localStorage.getItem("selectedGate");
            if(savedGate) {
                gateSelect.value = savedGate;
                triggerGateChange();
            }
        });

    // Khi chọn cổng
    gateSelect.addEventListener("change", triggerGateChange);

    function triggerGateChange() {
        const selectedGateId = gateSelect.value;
        localStorage.setItem("selectedGate", selectedGateId);

        // Cập nhật tổng suất ăn tại cổng
        fetch(`/PF/GetMealCountByGate?idgate=${selectedGateId}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById("totalGateMeals").textContent = `Tổng suất ăn tại cổng: ${data.count || 0}`;
            });

        // Cập nhật bảng AttLogs
        fetch(`/PF/GetAttLogsByGate?idgate=${selectedGateId}`)
            .then(res => res.json())
            .then(data => {
                const tbody = document.querySelector("#attLogsTable tbody");
                tbody.innerHTML = "";
                if(data.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Không có dữ liệu</td></tr>`;
                    return;
                }
data.forEach((log, index) => {
    const row = document.createElement("tr");
    row.innerHTML = `
        <td>${log.employeeId || "--"}</td>
        <td>${log.personName || "--"}</td>
        <td>${log.authDateTime || "--"}</td>
        <td>${log.direction || "--"}</td>
        <td>${log.deviceName || "--"}</td>
    `;
    tbody.appendChild(row);
});
            });

        // Thay đổi background theo cổng
        const body = document.body;
        if(selectedGateId === "1") body.style.background = "linear-gradient(to bottom right, #ffcccc, #ffb3b3)";
        else if(selectedGateId === "2") body.style.background = "linear-gradient(to bottom right, #ffecb3, #ffdb99)";
        else if(selectedGateId === "3") body.style.background = "linear-gradient(to bottom right, #ffffb3, #f2f2b3)";
        else if(selectedGateId === "4") body.style.background = "linear-gradient(to bottom right, #b3ffb3, #99ff99)";
        else body.style.background = "#f0f0f0";
    }

    // Tải tổng suất ăn toàn bộ
    fetch("/PF/TotalMeals")
        .then(res => res.json())
        .then(data => {
            document.getElementById("totalMeals").textContent = `Tổng suất ăn: ${data || 0}`;
        });
});

function closeMessage(){
    document.getElementById("message").style.display = "none";
}
</script>

</body>
</html>
